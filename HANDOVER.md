# プロジェクト引き継ぎドキュメント: 歯科医院向けAI診断レポートツール

## 1. プロジェクト概要

本プロジェクトは、MRC治療の初回診断プロセスを支援するWebアプリケーションのMVP（Minimum Viable Product）開発を目的としています。手動で入力された検査結果と口腔内写真のAI分析に基づき、客観的な診断サマリーと、保護者への動機付けを目的としたカウンセリングレポートを自動生成するツールです。

**参照ドキュメント:** `REQUIREMENTS.md` (プロジェクトのより詳細な要件定義書)

## 2. 開発環境

*   **Pythonバージョン:** 3.x (推奨)
*   **主要ライブラリ:**
    *   `FastAPI`: Webアプリケーションフレームワーク
    *   `uvicorn`: ASGIサーバー
    *   `reportlab`: PDF生成ライブラリ
    *   `Pillow` (PIL): 画像処理ライブラリ
    *   `google-generativeai`: Gemini API連携
    *   `markdown`: MarkdownからHTMLへの変換
    *   `python-dotenv`: 環境変数管理

*   **ライブラリのインストール:**
    プロジェクトルートディレクトリで以下のコマンドを実行してください。
    ```bash
    pip install -r requirements.txt
    ```

*   **.env ファイルの設定:**
    プロジェクトルートディレクトリに `.env` ファイルを作成し、Google Gemini APIキーを設定してください。
    ```
    GEMINI_API_KEY="YOUR_GEMINI_API_KEY"
    ```

*   **日本語フォントの配置:**
    プロジェクトルートディレクトリに `fonts` ディレクトリを作成し、その中に `ipaexg.ttf` (IPAexゴシック) フォントファイルを配置してください。
    IPAexフォントは[IPAのウェブサイト](https://moji.or.jp/ipafont/)からダウンロードできます。

## 3. ファイル構造

```
C:\Users\mayum\dev\dental_ai_report\
├───main.py             # FastAPIアプリケーションのメインロジック
├───PROJECT_PLAN.md     # プロジェクトのロードマップと進捗
├───REQUIREMENTS.md     # 詳細な要件定義書 (このドキュメント)
├───requirements.txt    # Pythonライブラリの依存関係
├───templates\          # HTMLテンプレートファイル
│   └───index.html      # メインの入力フォーム
└───uploads\            # アップロードされたファイルの一時保存場所
    └───(生成されたPDFや処理された画像)
```

## 4. 実装済みの機能

### 4.1. Webインターフェース (`templates/index.html`)

*   **UI/UX改善:** カテゴリB（安心感と親しみやすさを強調する地域密着型・ファミリー向け）の雰囲気に合わせて、配色、フォント、フォーム要素のスタイルを調整済みです。
*   **入力項目の追加:** 「仮想「新・MRC総合検査シート（最終版）」」で定義された患者基本情報、問診項目、口腔内検査項目がHTMLフォームに追加されています。
    *   患者氏名、年齢、生年月日、性別、保護者氏名、連絡先電話番号、メールアドレス、主訴、既往歴・アレルギー。
    *   口呼吸の有無、指しゃぶりの有無、爪噛みの有無、舌癖の有無、いびきの有無、扁桃腺の腫れの有無、アレルギー性鼻炎の有無、食事中の音、嚥下パターン。
    *   上顎歯列の状態、下顎歯列の状態、正中線のずれ、交叉咬合の有無、舌の位置（安静時）、口唇閉鎖、顔貌、TMD症状の有無、その他口腔内所見。
*   **口腔内写真アップロード:** 複数の口腔内写真（正面観、上顎咬合面観、下顎咬合面観、右側方観、左側方観）のアップロードに対応するフォーム要素が追加されています。

### 4.2. バックエンド (`main.py`)

*   **FastAPIによるWebサーバー構築:** アプリケーションの基盤が構築されています。
*   **フォームデータの受け取り:** `templates/index.html` から送信される患者基本情報、問診項目、口腔内検査項目の一部を受け取ることができます。
*   **ファイルアップロードと保存:** アップロードされた口腔内写真を `uploads` ディレクトリに保存します。
*   **Gemini Vision APIによる画像解析:**
    *   アップロードされた口腔内写真をGemini Vision API (`models/gemini-1.5-flash`) に送信し、詳細な分析結果を取得します。
    *   プロンプトを調整し、分析結果に加えて画像の向きと主要な歯列領域のバウンディングボックス座標（JSON形式）を要求します。
    *   Geminiの応答をパースし、分析結果、向き、歯列領域の情報を抽出します。
*   **画像の向きの自動補正:** Geminiから取得した向き情報に基づいて、画像を正しい向きに自動で回転させます。
*   **画像の規格化（トリミングとリサイズ）:** Geminiから取得した歯列領域のバウンディングボックス座標に基づいて、画像をトリミングし、固定サイズ（400px x 300px）にリサイズします。これにより、PDFレポートへの画像埋め込みが適切に行われます。
*   **PDFレポート生成:** `reportlab` を使用して、分析結果を含むPDFレポートを生成します。
*   **PDFレポートの日本語表示:** `ipaexg.ttf` フォントを埋め込むことで、PDF内の日本語が文字化けせずに表示されます。
*   **Gemini解析結果のPDFへの整形表示:** Markdown形式のGemini解析結果をHTMLに変換し、`reportlab.platypus.Paragraph` を使用してPDF内で整形して表示します。
*   **エラーハンドリング:** PDF生成時やGemini API呼び出し時にエラーが発生した場合、ターミナルに詳細なエラーメッセージを出力し、ユーザーにフィードバックを返します。

## 5. 現在の課題と残りのタスク

### 5.1. `main.py` の `diagnose` 関数への入力項目追加

*   **現状:** `templates/index.html` には全ての入力項目が追加されていますが、`main.py` の `diagnose` 関数では、まだ全ての項目を受け取れていません。
*   **タスク:** 問診項目、口腔内検査項目、複数の口腔内写真アップロード項目（`oral_photo_front`, `oral_photo_upper_occlusal` など）を `diagnose` 関数の引数として追加する必要があります。
    *   `oral_photo: UploadFile = File(...)` は削除し、各口腔内写真に対応する `Optional[UploadFile] = File(None)` に置き換える必要があります。

### 5.2. 診断ロジックの強化

*   **現状:** `main.py` の診断ロジックはまだダミーのままです。
*   **タスク:** 仮想「AI判断ロジック一覧」に基づき、新しい入力項目とGeminiの解析結果を組み合わせて、以下のロジックを実装する必要があります。
    *   リスク判定ロジック
    *   アプライアンス選択ロジック
    *   スコア計算ロジック
    *   術者向けおよび保護者向けレポート文章の生成ロジック

### 5.3. PDFレポートのさらなる見やすさの追求

*   **現状:** 日本語表示と基本的な整形はできていますが、より複雑なレイアウトやスタイルの適用は未着手です。
*   **タスク:** 
    *   Geminiの解析結果に含まれるMarkdownのより高度な要素（テーブル、コードブロック、リストのネストなど）の `reportlab` での適切な表示対応。
    *   カスタム `ParagraphStyle` を使用した、見出しや箇条書きの視覚的な強調。
    *   複数写真のPDFへの埋め込みと、それぞれの写真に対するGeminiの解析結果の紐付け、および適切なレイアウト調整。

### 5.4. WebインターフェースのUI/UX改善

*   **現状:** カテゴリBの雰囲気に合わせた基本的なデザイン調整は行いましたが、操作性やフィードバックの面で改善の余地があります。
*   **タスク:** 
    *   入力エラー時のユーザーへの分かりやすいフィードバック表示（FastAPIのバリデーションエラーをJavaScriptで捕捉し、フォーム上に表示）。
    *   フォーム送信中のローディングアニメーションの強化（より視覚的に分かりやすいもの）。
    *   全体的なデザインの微調整と、ユーザーテストによる改善点の洗い出し。

### 5.5. Renderへのデプロイ

*   **現状:** 未着手です。
*   **タスク:** 商談用にアプリケーションをWeb上に公開するためのデプロイ作業。

## 6. アプリケーションの起動方法

1.  **必要なライブラリのインストール:**
    プロジェクトルートディレクトリで以下のコマンドを実行してください。
    ```bash
    pip install -r requirements.txt
    ```
2.  **.env ファイルの設定:**
    プロジェクトルートディレクトリに `.env` ファイルを作成し、Google Gemini APIキーを設定してください。
    ```
    GEMINI_API_KEY="YOUR_GEMINI_API_KEY"
    ```
3.  **日本語フォントの配置:**
    プロジェクトルートディレクトリに `fonts` ディレクトリを作成し、その中に `ipaexg.ttf` (IPAexゴシック) フォントファイルを配置してください。
    IPAexフォントは[IPAのウェブサイト](https://moji.or.jp/ipafont/)からダウンロードできます。
4.  **アプリケーションの起動:**
    プロジェクトルートディレクトリで以下のコマンドを実行してください。
    ```bash
    python main.py
    ```
    または、開発中は自動リロード機能がある `uvicorn` の使用が便利です。
    ```bash
    uvicorn main:app --reload
    ```
5.  **ブラウザでのアクセス:**
    アプリケーションが起動したら、ウェブブラウザで `http://127.0.0.1:8000` にアクセスしてください。

---

**このドキュメントで、現在のプロジェクトの状態と今後の課題が明確になったかと思います。**

**何かご不明な点や、追加で必要な情報がございましたら、お気軽にお申し付けください。**

**これにて、本プロジェクトの引き継ぎを完了いたします。**